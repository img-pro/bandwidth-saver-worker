# WordPress Image CDN Worker Configuration Example
# Copy this file to wrangler.toml and configure for your environment
#
# SINGLE-DOMAIN ARCHITECTURE (v1.1.0+)
# The worker serves images directly - no separate R2 public bucket needed.
# This simplifies setup and enables future features like custom domains.

# ==============================================================================
# Test/Development Environment
# ==============================================================================

name = "image-cdn-worker-test"
main = "src/index.ts"
compatibility_date = "2025-01-15"
compatibility_flags = ["nodejs_compat"]

# Worker routes - this IS your CDN domain
# All image requests go through the worker
routes = [
  { pattern = "cdn.yourdomain.com/*", zone_name = "yourdomain.com" }
]

# R2 bucket for image caching (private bucket - worker handles access)
[[r2_buckets]]
binding = "R2"
bucket_name = "imgpro-cdn-test"

# Environment variables
[vars]
# Allowed origin domains (comma-separated or "*" for all)
# Examples: "example.com,blog.example.com" or "*"
ALLOWED_ORIGINS = "*"

# Debug mode (enables workflow logging to console)
# Set to "true" for development, "false" for production
DEBUG = "true"

# Maximum file size for caching
# Formats: "B", "KB", "MB", "GB", "TB"
# Examples: "50MB", "100MB", "1GB"
MAX_FILE_SIZE = "50MB"

# Fetch timeout in milliseconds
# How long to wait for origin response before timing out
FETCH_TIMEOUT = "30000"

# User-Agent header sent to origin servers
# Helps origins identify requests from your CDN
ORIGIN_USER_AGENT = "ImageCDN/1.0 WordPress Cache"

# ==============================================================================
# Production Environment
# ==============================================================================

[env.production]
name = "image-cdn-worker-prod"

# Production routes
routes = [
  { pattern = "cdn.yourdomain.com/*", zone_name = "yourdomain.com" }
]

# Production environment variables
[env.production.vars]
ALLOWED_ORIGINS = "*"
DEBUG = "false"                    # Disable debug logging in production
MAX_FILE_SIZE = "100MB"            # Higher limit for production
FETCH_TIMEOUT = "30000"
ORIGIN_USER_AGENT = "ImageCDN/1.0 WordPress Cache"

# Production R2 bucket
[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "imgpro-cdn-prod"

# ==============================================================================
# Configuration Notes
# ==============================================================================

# SETUP STEPS:
# 1. Copy to wrangler.toml: cp wrangler.toml.example wrangler.toml
# 2. Update domain and bucket names for your environment
# 3. Create R2 bucket: wrangler r2 bucket create [bucket-name]
# 4. Add custom domain in Cloudflare dashboard
# 5. Deploy: npm run deploy (test) or npm run deploy:prod (production)

# Custom Domain Setup:
# - Workers & Pages > [worker-name] > Settings > Domains
# - Click "Add Custom Domain"
# - Enter domain (e.g., cdn.yourdomain.com)
# - DNS records created automatically
# - SSL/TLS certificate provisioned automatically

# NOTE: R2 bucket should remain PRIVATE
# The worker handles all access and caching. No public bucket needed.
