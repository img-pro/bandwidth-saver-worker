# Bandwidth Saver Worker - Self-Hosted Configuration
#
# This worker caches WordPress images in Cloudflare R2 and serves them globally.
# No external dependencies - just R2 storage and your Cloudflare account.
#
# SETUP:
#   1. Copy this file: cp wrangler.toml.example wrangler.toml
#   2. Replace ALL instances of "example.com" with your actual domain
#   3. Replace YOUR_ACCOUNT_ID with your Cloudflare account ID
#   4. Create R2 bucket: wrangler r2 bucket create bandwidth-saver-cache
#   5. Deploy: npm run deploy
#   6. Add custom domain in Cloudflare dashboard (see README)

name = "bandwidth-saver"
main = "src/index.ts"
compatibility_date = "2025-01-15"
compatibility_flags = ["nodejs_compat"]

# Your Cloudflare account ID
# Find it: wrangler whoami, or in dashboard URL after /accounts/
account_id = "YOUR_ACCOUNT_ID"

# =============================================================================
# CDN DOMAIN - Where browsers request images from
# =============================================================================
# pattern: Your CDN subdomain (e.g., cdn.example.com, images.example.com)
# zone_name: The Cloudflare zone (your root domain, must be in your account)
routes = [
  { pattern = "cdn.example.com/*", zone_name = "example.com" }
]

# R2 bucket for image caching (private - worker handles all access)
[[r2_buckets]]
binding = "R2"
bucket_name = "bandwidth-saver-cache"

# =============================================================================
# ORIGIN DOMAINS - Your WordPress site(s) that images are fetched FROM
# =============================================================================
# URL format: https://CDN_DOMAIN/ORIGIN_DOMAIN/path/to/image.jpg
# Example:    https://cdn.example.com/example.com/wp-content/uploads/photo.jpg
#                     └─────┬───────┘ └────┬────┘
#                      CDN domain    Origin domain

[vars]
# ORIGIN_MODE: Which sites can use this CDN
#   "list" (recommended) - Only allow domains in ALLOWED_ORIGINS
#   "open"               - Allow any domain (testing only)
ORIGIN_MODE = "list"

# ALLOWED_ORIGINS: Your WordPress site domain(s)
# These are the domains the CDN will fetch images FROM
#
# Examples:
#   Single site:    "example.com"
#   With www:       "example.com,www.example.com"
#   Wildcard:       "*.example.com" (subdomains only, NOT example.com itself)
#
ALLOWED_ORIGINS = "example.com,www.example.com"

# BLOCKED_ORIGINS: Domains to always reject (optional)
# Use "*" as emergency kill switch to block all traffic
BLOCKED_ORIGINS = ""

# Maximum image file size to cache (larger files redirect to origin)
MAX_FILE_SIZE = "50MB"

# Origin fetch timeout in milliseconds
FETCH_TIMEOUT = "30000"

# Debug mode - enables ?view=1 parameter for troubleshooting
# SECURITY: Set to "false" in production
DEBUG = "false"
